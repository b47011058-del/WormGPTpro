<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WormGPT - High Precision UI</title>
    <!-- مكتبات JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark-reasonable.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <style>
        /* إعدادات الألوان والخطوط الدقيقة */
        :root {
            --bg-red-glow: #600202;
            --bg-black: #000000;
            --main-red: #ff3333;
            --sub-red: #a32222;
            --input-bg: #111111;
            --border-gray: #2c2c2c;
            --text-white: #ffffff;
            --text-dim: #707070;
            --message-user-bg: rgba(255, 51, 51, 0.1);
            --message-bot-bg: rgba(30, 30, 30, 0.9);
            --loading-red: #ff3333;
            --success-green: #00ff88;
            --error-red: #ff4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            background: radial-gradient(circle at center, var(--bg-red-glow) 0%, var(--bg-black) 75%);
            height: 100vh;
            height: 100dvh;
            color: var(--text-white);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
        }

        body::after {
            content: "";
            position: absolute;
            inset: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%);
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 9999;
            opacity: 0.6;
        }

        /* ==================== LAYOUT ==================== */
        #chat-wrapper {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 10;
            transition: filter 0.3s;
        }

        body.blur-active #chat-wrapper {
            filter: blur(8px);
            pointer-events: none;
        }

        /* --- الهيدر العلوي --- */
        .chat-header {
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(10, 0, 0, 0.95);
            border-bottom: 1px solid #330000;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }

        #title {
            color: var(--main-red);
            font-weight: 900;
            font-size: 1.3rem;
            letter-spacing: -0.5px;
            text-shadow: 0 0 10px rgba(255, 0, 0, 0.3);
        }

        .header-btn {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            color: #ccc;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: 0.2s;
        }

        .header-btn:active {
            transform: scale(0.95);
        }

        /* --- منطقة المحادثة --- */
        #chat-box {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            scroll-behavior: smooth;
        }

        #chat-box::-webkit-scrollbar {
            width: 4px;
        }

        #chat-box::-webkit-scrollbar-track {
            background: transparent;
        }

        #chat-box::-webkit-scrollbar-thumb {
            background: var(--main-red);
            border-radius: 2px;
        }

        /* شاشة الترحيب */
        .welcome-screen {
            text-align: center;
            margin: auto;
            padding: 20px;
            animation: fadeIn 0.8s ease-out;
        }

        .welcome-screen h1 {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 15px;
            letter-spacing: 0.5px;
        }

        .welcome-screen h2 {
            font-size: 1.4rem;
            color: var(--sub-red);
            font-weight: 500;
            margin-bottom: 30px;
        }

        .welcome-badge {
            background: rgba(255, 51, 51, 0.1);
            border: 1px solid rgba(255, 51, 51, 0.3);
            border-radius: 20px;
            padding: 10px 20px;
            display: inline-block;
            font-size: 0.9rem;
            color: var(--main-red);
        }

        /* رسائل المحادثة */
        .message {
            max-width: 85%;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-user {
            align-self: flex-end;
            margin-left: auto;
        }

        .message-bot {
            align-self: flex-start;
            margin-right: auto;
        }

        .msg-bubble {
            padding: 12px 16px;
            border-radius: 18px;
            line-height: 1.6;
            word-wrap: break-word;
            position: relative;
            font-size: 0.95rem;
            user-select: text;
        }

        .message-user .msg-bubble {
            background: var(--message-user-bg);
            border: 1px solid rgba(255, 51, 51, 0.3);
            border-bottom-right-radius: 5px;
            backdrop-filter: blur(10px);
            color: #fff;
        }

        .message-bot .msg-bubble {
            background: var(--message-bot-bg);
            border: 1px solid var(--border-gray);
            border-bottom-left-radius: 5px;
            backdrop-filter: blur(10px);
            color: #ddd;
        }

        /* شاشة الترخيص */
        .license-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.97);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            opacity: 1;
            pointer-events: all;
        }

        .license-box {
            background: #111;
            padding: 35px;
            border-radius: 20px;
            width: 100%;
            max-width: 500px;
            border: 1px solid #333;
            box-shadow: 0 10px 50px rgba(0,0,0,0.8);
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .license-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .license-header i {
            font-size: 3.5rem;
            color: var(--main-red);
            margin-bottom: 15px;
            display: block;
        }

        .license-title {
            font-size: 1.8rem;
            color: var(--main-red);
            font-weight: 900;
            margin-bottom: 10px;
        }

        .license-subtitle {
            font-size: 1rem;
            color: #888;
            margin-bottom: 30px;
            line-height: 1.5;
        }

        .key-format {
            background: rgba(255, 51, 51, 0.1);
            border: 1px solid rgba(255, 51, 51, 0.3);
            border-radius: 10px;
            padding: 12px;
            margin: 20px 0;
            text-align: center;
            font-family: 'Courier New', monospace;
            font-size: 1.1rem;
            letter-spacing: 2px;
            color: var(--success-green);
        }

        .license-status {
            padding: 12px;
            border-radius: 10px;
            text-align: center;
            font-size: 0.9rem;
            margin-top: 15px;
            transition: all 0.3s ease;
        }

        .license-status.success {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
            color: var(--success-green);
        }

        .license-status.error {
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid rgba(255, 68, 68, 0.3);
            color: var(--error-red);
        }

        .license-info {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #333;
            font-size: 0.8rem;
            color: #666;
            display: flex;
            justify-content: space-between;
        }

        /* الكود بلوكس */
        .code-wrapper {
            margin: 10px 0;
            border-radius: 10px;
            overflow: hidden;
            background: rgba(20, 20, 20, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            direction: ltr !important;
            text-align: left !important;
        }

        .code-header {
            padding: 8px 12px;
            background: rgba(30, 30, 30, 0.9);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'Fira Code', monospace;
            font-size: 0.8rem;
            color: var(--text-dim);
        }

        .copy-btn {
            background: rgba(255, 51, 51, 0.1);
            border: 1px solid rgba(255, 51, 51, 0.2);
            color: var(--main-red);
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .copy-btn:active {
            transform: scale(0.95);
            background: rgba(255, 51, 51, 0.2);
        }

        pre {
            padding: 12px;
            overflow-x: auto;
            margin: 0;
            font-family: 'Fira Code', 'Consolas', 'Monaco', monospace;
            font-size: 0.85rem;
            direction: ltr;
        }

        pre code {
            direction: ltr !important;
            text-align: left !important;
            font-family: 'Fira Code' !important;
        }

        /* أزرار الرسائل */
        .msg-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            padding-top: 8px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .msg-action-btn {
            flex: 1;
            padding: 6px 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--text-dim);
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .msg-action-btn:active {
            background: rgba(255, 51, 51, 0.1);
            transform: scale(0.98);
        }

        .msg-action-btn.playing {
            background: var(--main-red);
            color: #fff;
            border-color: var(--main-red);
        }

        /* مؤشر التحميل */
        .loading-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            align-self: flex-start;
        }

        .loading-dots {
            display: flex;
            gap: 5px;
        }

        .loading-dot {
            width: 6px;
            height: 6px;
            background: var(--loading-red);
            border-radius: 50%;
        }

        /* رسالة الخطأ */
        .error-message {
            background: rgba(255, 51, 51, 0.1);
            border: 1px solid rgba(255, 51, 51, 0.3);
            border-radius: 12px;
            padding: 10px 14px;
            margin: 5px 0;
            color: var(--main-red);
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: fadeIn 0.3s ease-out;
        }

        /* --- شريط الإدخال السفلي --- */
        .input-wrapper {
            background: rgba(0,0,0,0.95);
            border-top: 1px solid #222;
            padding: 12px;
            padding-bottom: max(12px, env(safe-area-inset-bottom));
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* الخط الأفقي الرفيع فوق الإدخال */
        .divider {
            width: 85%;
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            margin-bottom: 25px;
        }

        .input-box {
            width: 100%;
            max-width: 850px;
            background: var(--input-bg);
            border: 1.5px solid var(--border-gray);
            border-radius: 40px;
            display: flex;
            align-items: center;
            padding: 8px 15px;
            margin-bottom: 12px;
            transition: all 0.3s;
        }

        .input-box:focus-within {
            border-color: var(--main-red);
            box-shadow: 0 0 15px rgba(255, 51, 51, 0.2);
        }

        /* زر الميكروفون (يمين) */
        .mic-icon {
            color: var(--text-white);
            padding: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: all 0.3s;
            background: transparent;
            border: none;
        }

        .mic-icon.mic-active {
            color: var(--main-red);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                box-shadow: 0 0 10px rgba(255, 51, 51, 0.5);
            }
            50% {
                opacity: 0.7;
                box-shadow: 0 0 20px rgba(255, 51, 51, 0.8);
            }
        }

        .mic-icon:active {
            transform: scale(0.95);
        }

        textarea {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-white);
            font-size: 1.1rem;
            padding: 10px 15px;
            text-align: right;
            outline: none;
            font-family: inherit;
            max-height: 100px;
            resize: none;
            overflow-y: auto;
        }

        textarea::placeholder {
            color: var(--text-dim);
        }

        /* زر الإرسال الدائري (يسار) */
        .send-btn {
            background: var(--text-white);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            opacity: 0.7;
        }

        .send-btn:not(:disabled) {
            opacity: 1;
            background: var(--main-red);
        }

        .send-btn:not(:disabled) svg {
            fill: white;
        }

        .send-btn:active {
            transform: scale(0.95);
        }

        .send-btn svg {
            width: 20px;
            height: 20px;
            fill: var(--bg-black);
            transition: all 0.3s;
        }

        .send-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* النص الصغير جداً في الأسفل */
        .footer-note {
            font-size: 0.72rem;
            color: var(--text-dim);
            text-align: center;
            max-width: 90%;
            line-height: 1.5;
            margin-top: 5px;
        }

        /* شاشة تسجيل الدخول */
        .login-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            z-index: 9998;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .login-modal.active {
            opacity: 1;
            pointer-events: all;
        }

        .login-box {
            background: #111;
            padding: 30px;
            border-radius: 20px;
            width: 100%;
            max-width: 400px;
            border: 1px solid #333;
            box-shadow: 0 10px 50px rgba(0,0,0,0.8);
        }

        .login-logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-logo i {
            font-size: 3rem;
            color: var(--main-red);
        }

        .login-title {
            text-align: center;
            font-size: 1.5rem;
            color: var(--main-red);
            margin-bottom: 10px;
            font-weight: 900;
        }

        .login-subtitle {
            text-align: center;
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 30px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: #888;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 10px;
            color: #fff;
            font-size: 1rem;
            transition: 0.2s;
            text-align: center;
            letter-spacing: 2px;
            font-family: 'Courier New', monospace;
        }

        .input-group input:focus {
            border-color: var(--main-red);
            box-shadow: 0 0 15px rgba(255, 51, 51, 0.2);
        }

        .btn-primary {
            width: 100%;
            padding: 14px;
            background: var(--main-red);
            border: none;
            border-radius: 10px;
            color: #fff;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
            margin-top: 10px;
        }

        .btn-primary:hover {
            background: #cc0029;
            transform: translateY(-2px);
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* القائمة الجانبية */
        .side-menu {
            position: fixed;
            top: 0;
            right: -350px;
            width: 350px;
            height: 100%;
            background: rgba(10, 10, 10, 0.98);
            backdrop-filter: blur(20px);
            z-index: 2000;
            transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-left: 1px solid var(--border-gray);
            overflow-y: auto;
            padding: 20px;
            box-shadow: -5px 0 20px rgba(0,0,0,0.5);
        }

        .side-menu.active {
            right: 0;
        }

        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }

        .menu-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* الرسومات المتحركة */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes bounce {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-8px);
            }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        /* تعديلات الموبايل */
        @media (max-width: 600px) {
            .chat-header { padding: 15px 20px; }
            #title { font-size: 1.1rem; }
            #chat-box { padding: 15px 20px; }
            .message { max-width: 90%; }
            .welcome-screen h1 { font-size: 1.4rem; }
            .welcome-screen h2 { font-size: 1.1rem; }
            .input-box { padding: 6px 12px; }
            .side-menu { width: 85%; }
            .license-box { padding: 25px 20px; }
            .login-box { padding: 20px; }
            .license-title { font-size: 1.5rem; }
        }

        /* دعم iOS */
        @supports (-webkit-touch-callout: none) {
            body {
                height: -webkit-fill-available;
            }
            
            .input-wrapper {
                padding-bottom: calc(12px + env(safe-area-inset-bottom));
            }
        }
    </style>
</head>
<body>

    <!-- شاشة الترخيص -->
    <div class="license-modal" id="licenseModal">
        <div class="license-box">
            <div class="license-header">
                <i class="fas fa-key"></i>
                <h2 class="license-title">WORMGPT ACCESS</h2>
                <p class="license-subtitle">
                    أدخل مفتاح الترخيص المكون من 14 حرفاً (أرقام وحروف إنجليزية)
                </p>
                
                <div class="key-format">XXXX-XXXX-XXXX</div>
            </div>
            
            <div class="input-group">
                <label for="licenseKey">مفتاح الترخيص</label>
                <input 
                    type="text" 
                    id="licenseKey" 
                    placeholder="أدخل المفتاح هنا"
                    maxlength="14"
                    autocomplete="off"
                    autocapitalize="characters"
                >
            </div>
            
            <div id="licenseStatus" class="license-status" style="display: none;"></div>
            
            <button class="btn-primary" id="activateBtn">
                <i class="fas fa-unlock"></i>
                <span>تفعيل</span>
            </button>
            
            <div class="license-info">
                <span>الإصدار: Premium 2.0</span>
                <span>متطلب: 14 حرف</span>
            </div>
        </div>
    </div>

    <!-- شاشة تسجيل الدخول -->
    <div class="login-modal" id="loginModal">
        <div class="login-box">
            <div class="login-logo">
                <i class="fas fa-robot"></i>
            </div>
            <h2 class="login-title">WORMGPT</h2>
            <p class="login-subtitle">AI Assistant - No Limits, No Restrictions</p>
            
            <div class="input-group">
                <label for="loginUsername">اسم المستخدم</label>
                <input type="text" id="loginUsername" placeholder="أدخل اسمك" autocomplete="off">
            </div>
            
            <button class="btn-primary" id="loginBtn">بدء المحادثة</button>
            
            <div style="margin-top: 24px; display: flex; justify-content: space-between; font-size: 0.8rem; color: #666;">
                <span>الحالة: <span style="color: var(--main-red)">● مفعل</span></span>
                <span>وصول غير محدود ✓</span>
            </div>
        </div>
    </div>

    <!-- القائمة الجانبية -->
    <div class="menu-overlay" id="menuOverlay"></div>
    <div class="side-menu" id="sideMenu">
        <div style="margin-bottom: 30px;">
            <h3 style="color: var(--main-red); margin-bottom: 20px;">إعدادات WormGPT</h3>
            <div style="background: rgba(255, 51, 51, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <div style="color: var(--main-red); font-size: 0.9rem; margin-bottom: 5px;">حالة الحساب</div>
                <div style="color: var(--main-red); font-size: 1rem;">
                    <i class="fas fa-check-circle"></i>
                    <span style="margin-right: 8px;">● نشط & غير محدود</span>
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <div style="color: #888; font-size: 0.9rem; margin-bottom: 10px;">الميزات</div>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(255, 255, 255, 0.05); border-radius: 8px;">
                        <i class="fas fa-infinity" style="color: var(--main-red);"></i>
                        <span>رسائل غير محدودة</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(255, 255, 255, 0.05); border-radius: 8px;">
                        <i class="fas fa-microphone" style="color: var(--main-red);"></i>
                        <span>إدخال صوتي</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(255, 255, 255, 0.05); border-radius: 8px;">
                        <i class="fas fa-code" style="color: var(--main-red);"></i>
                        <span>دعم الأكواد</span>
                    </div>
                </div>
            </div>
            
            <button id="logoutBtn" style="width: 100%; padding: 12px; background: rgba(255, 51, 51, 0.1); border: 1px solid rgba(255, 51, 51, 0.3); color: var(--main-red); border-radius: 10px; font-size: 1rem; cursor: pointer; transition: all 0.2s; margin-top: 20px;">
                <i class="fas fa-sign-out-alt"></i>
                <span style="margin-right: 8px;">تسجيل الخروج</span>
            </button>
        </div>
    </div>

    <!-- واجهة المحادثة الرئيسية -->
    <div id="chat-wrapper">
        <!-- الهيدر العلوي -->
        <header class="chat-header">
            <div id="title">WormGPT HackerExos</div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <button class="header-btn" id="clearBtn" title="مسح المحادثة">
                    <i class="fas fa-trash"></i>
                </button>
                <div class="header-btn" id="menuBtn" title="الإعدادات">
                    <div style="width: 20px; height: 20px; border: 2px solid var(--main-red); border-radius: 50%; display: flex; align-items: center; justify-content: center; position: relative;">
                        <div style="width: 10px; height: 10px; border: 2px solid var(--main-red); border-radius: 50%; border-top-color: transparent; transform: rotate(45deg);"></div>
                    </div>
                </div>
            </div>
        </header>

        <!-- منطقة المحادثة -->
        <main id="chat-box">
            <!-- شاشة الترحيب -->
            <div class="welcome-screen">
                <h1>كيف يمكنني مساعدتك سيدي؟</h1>
                <h2>مرحباً بك في WormGPT</h2>
                <div class="welcome-badge">
                    <span>✨ رسائل غير محدودة ✨</span>
                </div>
            </div>
        </main>

        <!-- شريط الإدخال السفلي -->
        <footer class="input-wrapper">
            <div class="divider"></div>
            
            <div class="input-box">
                <button class="send-btn" id="submitBtn" disabled>
                    <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
                </button>

                <textarea 
                    id="chatInput" 
                    placeholder="اسأل عن أي شيء"
                    rows="1"
                    oninput="autoResize(this)"
                ></textarea>

                <button class="mic-icon" id="micBtn">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
                </button>
            </div>

            <p class="footer-note">
                هذا النموذج معطل، لذلك قد لا يساعدك في بعض الأحيان، قد يفشل النموذج؛ تحقق من الإجابات.
            </p>
        </footer>
    </div>

    <script>
        // الإعدادات
        const CONFIG = {
            API_URL: "https://udghbdlcrzvkfsyjqkch.supabase.co/functions/v1/chat",
            API_KEY: "wgpt_Ibpy8rL4-Apdj-3GDX-JKzt-q07HH1W2nb77",
            MAX_MESSAGE_LENGTH: 5000,
            // المفاتيح الصالحة (يمكنك إضافة المزيد)
            VALID_LICENSE_KEYS: [
                "WG4T8H7K9D2F5R", // مفتاح افتراضي 1
                "X3B7N9M2Q4R6T8", // مفتاح افتراضي 2
                "A1B2C3D4E5F6G7", // مفتاح افتراضي 3
                "H8J9K0L1M2N3P4", // مفتاح افتراضي 4
                "Q5W6E7R8T9Y0U1"  // مفتاح افتراضي 5
            ]
        };

        // العناصر
        const elements = {
            licenseModal: document.getElementById('licenseModal'),
            licenseKey: document.getElementById('licenseKey'),
            licenseStatus: document.getElementById('licenseStatus'),
            activateBtn: document.getElementById('activateBtn'),
            loginModal: document.getElementById('loginModal'),
            loginUsername: document.getElementById('loginUsername'),
            loginBtn: document.getElementById('loginBtn'),
            chatBox: document.getElementById('chat-box'),
            chatInput: document.getElementById('chatInput'),
            submitBtn: document.getElementById('submitBtn'),
            micBtn: document.getElementById('micBtn'),
            clearBtn: document.getElementById('clearBtn'),
            menuBtn: document.getElementById('menuBtn'),
            menuOverlay: document.getElementById('menuOverlay'),
            sideMenu: document.getElementById('sideMenu'),
            logoutBtn: document.getElementById('logoutBtn')
        };

        // الحالة
        let state = {
            isLicensed: localStorage.getItem('wgpt_licensed') === 'true',
            licenseKey: localStorage.getItem('wgpt_license_key') || '',
            username: localStorage.getItem('wgpt_username') || '',
            sessionId: 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
            conversation: JSON.parse(localStorage.getItem('wgpt_conversation')) || [],
            isRecording: false,
            recognition: null,
            isConnected: true
        };

        // تهيئة التطبيق
        function initApp() {
            // التحقق من الترخيص
            if (!state.isLicensed) {
                showLicenseModal();
            } else {
                // التحقق من تسجيل الدخول
                if (!state.username) {
                    elements.loginModal.classList.add('active');
                    elements.loginUsername.focus();
                } else {
                    showChatInterface();
                }
            }

            setupEventListeners();
            
            // تحديث حالة الاتصال
            updateConnectionStatus();
            
            // إضافة مستمعي الأحداث
            window.addEventListener('online', updateConnectionStatus);
            window.addEventListener('offline', updateConnectionStatus);
        }

        // إعداد المستمعين
        function setupEventListeners() {
            // زر التفعيل (الترخيص)
            elements.activateBtn.addEventListener('click', handleLicenseActivation);
            elements.licenseKey.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLicenseActivation();
            });
            
            // تسجيل الدخول
            elements.loginBtn.addEventListener('click', handleLogin);
            elements.loginUsername.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLogin();
            });

            // زر الإرسال
            elements.submitBtn.addEventListener('click', sendMessage);
            
            // إدخال النص
            elements.chatInput.addEventListener('input', handleInputChange);
            
            // زر Enter
            elements.chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // الميكروفون
            elements.micBtn.addEventListener('click', toggleVoiceInput);
            
            // مسح المحادثة
            elements.clearBtn.addEventListener('click', clearChat);
            
            // القائمة
            elements.menuBtn.addEventListener('click', toggleMenu);
            elements.menuOverlay.addEventListener('click', toggleMenu);
            elements.logoutBtn.addEventListener('click', handleLogout);
            
            // إدخال مفتاح الترخيص
            elements.licenseKey.addEventListener('input', formatLicenseKey);
        }

        // عرض شاشة الترخيص
        function showLicenseModal() {
            elements.licenseModal.style.display = 'flex';
            elements.licenseKey.focus();
        }

        // إخفاء شاشة الترخيص
        function hideLicenseModal() {
            elements.licenseModal.style.display = 'none';
        }

        // تنسيق مفتاح الترخيص أثناء الكتابة
        function formatLicenseKey() {
            let value = elements.licenseKey.value.toUpperCase();
            
            // إزالة جميع الأحرف غير صالحة
            value = value.replace(/[^A-Z0-9]/g, '');
            
            // تحديث القيمة
            elements.licenseKey.value = value;
            
            // تمكين/تعطيل زر التفعيل
            elements.activateBtn.disabled = value.length !== 14;
        }

        // تفعيل الترخيص
        function handleLicenseActivation() {
            const key = elements.licenseKey.value.trim().toUpperCase();
            
            if (key.length !== 14) {
                showLicenseStatus('المفتاح يجب أن يكون 14 حرفاً', 'error');
                return;
            }

            // التحقق من صحة المفتاح
            if (isValidLicenseKey(key)) {
                // حفظ حالة الترخيص
                state.isLicensed = true;
                state.licenseKey = key;
                localStorage.setItem('wgpt_licensed', 'true');
                localStorage.setItem('wgpt_license_key', key);
                
                // عرض رسالة النجاح
                showLicenseStatus('✓ تم تفعيل الترخيص بنجاح!', 'success');
                
                // الانتقال إلى شاشة تسجيل الدخول بعد ثانيتين
                setTimeout(() => {
                    hideLicenseModal();
                    elements.loginModal.classList.add('active');
                    elements.loginUsername.focus();
                }, 2000);
            } else {
                showLicenseStatus('❌ مفتاح ترخيص غير صالح', 'error');
                elements.licenseKey.style.animation = 'shake 0.5s ease';
                setTimeout(() => {
                    elements.licenseKey.style.animation = '';
                }, 500);
            }
        }

        // التحقق من صحة مفتاح الترخيص
        function isValidLicenseKey(key) {
            // التحقق من الطول
            if (key.length !== 14) return false;
            
            // التحقق من التنسيق (أرقام وحروف إنجليزية فقط)
            if (!/^[A-Z0-9]{14}$/.test(key)) return false;
            
            // التحقق من المفاتيح الصالحة في CONFIG
            if (CONFIG.VALID_LICENSE_KEYS.includes(key)) {
                return true;
            }
            
            // يمكنك إضافة شروط التحقق الإضافية هنا
            // مثلاً: التحقق من checksum أو pattern معين
            
            return false;
        }

        // عرض حالة الترخيص
        function showLicenseStatus(message, type) {
            elements.licenseStatus.textContent = message;
            elements.licenseStatus.className = `license-status ${type}`;
            elements.licenseStatus.style.display = 'block';
        }

        // تسجيل الدخول
        function handleLogin() {
            const username = elements.loginUsername.value.trim();
            if (!username) {
                showError("يرجى إدخال اسم المستخدم");
                return;
            }

            if (username.length > 30) {
                showError("اسم المستخدم يجب أن يكون أقل من 30 حرفاً");
                return;
            }

            state.username = username;
            localStorage.setItem('wgpt_username', username);
            
            elements.loginModal.classList.remove('active');
            showChatInterface();
        }

        // عرض واجهة المحادثة
        function showChatInterface() {
            loadPreviousConversation();
            
            // تحديث زر الإرسال
            handleInputChange();
        }

        // تحميل المحادثة السابقة
        function loadPreviousConversation() {
            if (state.conversation.length > 0) {
                document.querySelector('.welcome-screen')?.remove();
                state.conversation.forEach(msg => {
                    addMessage(msg.role, msg.content, false);
                });
                scrollToBottom();
            }
        }

        // تحديث حالة الإدخال
        function handleInputChange() {
            const text = elements.chatInput.value.trim();
            elements.submitBtn.disabled = !text;
            autoResize(elements.chatInput);
        }

        // تعديل حجم مربع النص تلقائياً
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            const newHeight = Math.min(textarea.scrollHeight, 100);
            textarea.style.height = newHeight + 'px';
        }

        // إرسال الرسالة
        async function sendMessage() {
            const text = elements.chatInput.value.trim();
            if (!text) return;

            // التحقق من الطول
            if (text.length > CONFIG.MAX_MESSAGE_LENGTH) {
                showError(`الرسالة طويلة جداً (الحد الأقصى ${CONFIG.MAX_MESSAGE_LENGTH} حرف)`);
                return;
            }

            // إخفاء شاشة الترحيب
            document.querySelector('.welcome-screen')?.remove();

            // إضافة رسالة المستخدم
            addMessage('user', text);
            elements.chatInput.value = '';
            autoResize(elements.chatInput);
            elements.submitBtn.disabled = true;

            // حفظ في المحادثة
            state.conversation.push({ 
                role: 'user', 
                content: text, 
                timestamp: new Date().toISOString() 
            });
            saveConversation();

            // عرض مؤشر التحميل
            const loadingId = showLoading();

            try {
                // إرسال إلى API
                const response = await fetch(CONFIG.API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        api_key: CONFIG.API_KEY,
                        message: text,
                        session_id: state.sessionId,
                        user_id: state.username,
                        license_key: state.licenseKey // إرسال مفتاح الترخيص
                    })
                });

                // إخفاء التحميل
                removeLoading(loadingId);

                if (!response.ok) {
                    throw new Error(`خطأ في الخادم: ${response.status}`);
                }

                const data = await response.json();

                if (data.response) {
                    addMessage('bot', data.response);
                    state.conversation.push({ 
                        role: 'bot', 
                        content: data.response, 
                        timestamp: new Date().toISOString() 
                    });
                    saveConversation();
                } else {
                    addMessage('bot', `خطأ: ${data.error || 'خطأ غير معروف'}`);
                }

            } catch (error) {
                console.error('خطأ API:', error);
                removeLoading(loadingId);
                
                let errorMessage = "خطأ في الاتصال. يرجى المحاولة مرة أخرى.";
                if (error.message.includes('Failed to fetch')) {
                    errorMessage = "خطأ في الشبكة. يرجى التحقق من اتصالك.";
                }
                
                addMessage('bot', `⚠️ ${errorMessage}`);
            }
        }

        // إضافة رسالة للواجهة
        function addMessage(role, text, animate = true) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${role}`;
            
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'msg-bubble';
            
            if (role === 'user') {
                bubbleDiv.textContent = text;
            } else {
                // معالجة Markdown
                try {
                    const rawHtml = marked.parse(text);
                    const safeHtml = DOMPurify.sanitize(rawHtml);
                    bubbleDiv.innerHTML = safeHtml;
                    
                    // معالجة الأكواد
                    bubbleDiv.querySelectorAll('pre code').forEach(block => {
                        hljs.highlightElement(block);
                        
                        const wrapper = document.createElement('div');
                        wrapper.className = 'code-wrapper';
                        
                        const header = document.createElement('div');
                        header.className = 'code-header';
                        header.innerHTML = `
                            <span>كود</span>
                            <button class="copy-btn" onclick="copyCode(this)">نسخ</button>
                        `;
                        
                        const preElement = block.parentElement;
                        preElement.parentElement.replaceChild(wrapper, preElement);
                        wrapper.appendChild(header);
                        wrapper.appendChild(preElement);
                    });
                    
                    // إضافة أزرار الإجراءات
                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'msg-actions';
                    actionsDiv.innerHTML = `
                        <button class="msg-action-btn" onclick="copyMessage(this)">
                            <i class="fas fa-copy"></i> نسخ
                        </button>
                        <button class="msg-action-btn" onclick="speakMessage(this)">
                            <i class="fas fa-volume-up"></i> استماع
                        </button>
                    `;
                    bubbleDiv.appendChild(actionsDiv);
                    
                } catch (error) {
                    console.error('خطأ في تحليل Markdown:', error);
                    bubbleDiv.textContent = text;
                }
            }
            
            messageDiv.appendChild(bubbleDiv);
            elements.chatBox.appendChild(messageDiv);
            
            if (animate) {
                messageDiv.style.animation = 'fadeIn 0.3s ease';
            }
            
            scrollToBottom();
        }

        // عرض مؤشر التحميل
        function showLoading() {
            const loadingId = 'loading-' + Date.now();
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'loading-indicator';
            loadingDiv.id = loadingId;
            loadingDiv.innerHTML = `
                <div class="loading-dots">
                    <div class="loading-dot" style="animation: bounce 1.4s infinite;"></div>
                    <div class="loading-dot" style="animation: bounce 1.4s infinite 0.2s;"></div>
                    <div class="loading-dot" style="animation: bounce 1.4s infinite 0.4s;"></div>
                </div>
                <span>جاري المعالجة...</span>
            `;
            elements.chatBox.appendChild(loadingDiv);
            scrollToBottom();
            return loadingId;
        }

        // إخفاء التحميل
        function removeLoading(id) {
            const element = document.getElementById(id);
            if (element) {
                element.style.opacity = '0';
                element.style.transform = 'translateY(-10px)';
                element.style.transition = 'all 0.3s ease';
                setTimeout(() => {
                    if (element.parentElement) {
                        element.remove();
                    }
                }, 300);
            }
        }

        // عرض خطأ
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = `
                <i class="fas fa-exclamation-circle"></i>
                <span>${message}</span>
            `;
            
            elements.chatBox.appendChild(errorDiv);
            scrollToBottom();
            
            setTimeout(() => {
                if (errorDiv.parentElement) {
                    errorDiv.remove();
                }
            }, 5000);
        }

        // التمرير للأسفل
        function scrollToBottom() {
            requestAnimationFrame(() => {
                elements.chatBox.scrollTo({
                    top: elements.chatBox.scrollHeight,
                    behavior: 'smooth'
                });
            });
        }

        // حفظ المحادثة
        function saveConversation() {
            if (state.conversation.length > 0) {
                localStorage.setItem('wgpt_conversation', JSON.stringify(state.conversation));
            }
        }

        // مسح المحادثة
        function clearChat() {
            if (!confirm("هل أنت متأكد من رغبتك في مسح المحادثة؟")) return;
            
            state.conversation = [];
            state.sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.removeItem('wgpt_conversation');
            
            elements.chatBox.innerHTML = `
                <div class="welcome-screen">
                    <h1>كيف يمكنني مساعدتك سيدي؟</h1>
                    <h2>مرحباً بك في WormGPT</h2>
                    <div class="welcome-badge">
                        <span>✨ رسائل غير محدودة ✨</span>
                    </div>
                </div>
            `;
        }

        // تبديل الإدخال الصوتي
        function toggleVoiceInput() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition) {
                showError("الإدخال الصوتي غير مدعوم في متصفحك");
                return;
            }

            if (state.isRecording) {
                state.recognition.stop();
                return;
            }

            state.recognition = new SpeechRecognition();
            state.recognition.lang = 'ar-SA';
            state.recognition.continuous = false;
            state.recognition.interimResults = false;
            state.recognition.maxAlternatives = 1;

            state.recognition.onstart = () => {
                state.isRecording = true;
                elements.micBtn.classList.add('mic-active');
            };

            state.recognition.onend = () => {
                state.isRecording = false;
                elements.micBtn.classList.remove('mic-active');
            };

            state.recognition.onresult = (event) => {
                if (event.results && event.results.length > 0) {
                    const transcript = event.results[0][0].transcript;
                    elements.chatInput.value = transcript;
                    handleInputChange();
                }
            };

            state.recognition.onerror = (event) => {
                console.error('خطأ في التعرف الصوتي:', event.error);
                state.isRecording = false;
                elements.micBtn.classList.remove('mic-active');
                
                let errorMsg = "فشل التعرف الصوتي.";
                if (event.error === 'not-allowed') {
                    errorMsg = "تم رفض الوصول للميكروفون. يرجى السماح بالوصول في إعدادات المتصفح.";
                }
                
                showError(errorMsg);
            };

            try {
                state.recognition.start();
            } catch (error) {
                console.error('فشل بدء التعرف:', error);
                showError("فشل بدء التعرف الصوتي");
            }
        }

        // تبديل القائمة
        function toggleMenu() {
            elements.sideMenu.classList.toggle('active');
            elements.menuOverlay.classList.toggle('active');
            document.body.classList.toggle('blur-active');
        }

        // تسجيل الخروج
        function handleLogout() {
            if (!confirm("هل أنت متأكد من تسجيل الخروج؟")) return;
            
            localStorage.clear();
            state.username = '';
            state.conversation = [];
            state.isLicensed = false;
            state.sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            elements.loginModal.classList.remove('active');
            showLicenseModal();
            toggleMenu();
        }

        // تحديث حالة الاتصال
        function updateConnectionStatus() {
            state.isConnected = navigator.onLine;
            if (!state.isConnected) {
                showError("أنت غير متصل بالإنترنت الآن");
            }
        }

        // وظائف عامة
        window.copyCode = function(btn) {
            const codeWrapper = btn.closest('.code-wrapper');
            const codeElement = codeWrapper.querySelector('code');
            
            if (!codeElement) return;
            
            const code = codeElement.textContent;
            
            navigator.clipboard.writeText(code).then(() => {
                const originalText = btn.textContent;
                btn.textContent = 'تم النسخ!';
                btn.style.background = 'rgba(255, 51, 51, 0.3)';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                }, 2000);
            });
        };

        window.copyMessage = function(btn) {
            const bubble = btn.closest('.msg-bubble');
            const clone = bubble.cloneNode(true);
            
            clone.querySelectorAll('.msg-actions, .code-header').forEach(el => el.remove());
            
            const text = clone.textContent.trim();
            
            navigator.clipboard.writeText(text).then(() => {
                const icon = btn.querySelector('i');
                if (icon) {
                    const originalClass = icon.className;
                    icon.className = 'fas fa-check';
                    setTimeout(() => {
                        icon.className = originalClass;
                    }, 2000);
                }
            });
        };

        window.speakMessage = function(btn) {
            const bubble = btn.closest('.msg-bubble');
            const clone = bubble.cloneNode(true);
            
            clone.querySelectorAll('.msg-actions, .code-wrapper').forEach(el => el.remove());
            
            const text = clone.textContent.trim();

            if (!text) {
                showError("لا يوجد نص للقراءة");
                return;
            }

            if (!('speechSynthesis' in window)) {
                showError("القراءة النصية غير مدعومة في متصفحك");
                return;
            }

            const synth = window.speechSynthesis;
            synth.cancel();

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ar-SA';
            utterance.rate = 1;

            btn.classList.add('playing');
            
            utterance.onend = () => {
                btn.classList.remove('playing');
            };
            
            utterance.onerror = () => {
                btn.classList.remove('playing');
                showError("فشل في قراءة النص");
            };

            synth.speak(utterance);
        };

        // بدء التطبيق
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
    </html>
